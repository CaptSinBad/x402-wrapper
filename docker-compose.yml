version: '3.8'

# Minimal docker-compose for running the web and worker services.
# For local development with Postgres, use the included override file:
#   docker-compose -f docker-compose.yml -f docker-compose.override.yml up --build

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env.client
    ports:
      - '3000:3000'
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    env_file:
      - .env.server
    restart: unless-stopped

  webhook-dispatcher:
    build:
      context: .
      dockerfile: Dockerfile
    command: node scripts/webhookDispatcher.js
    env_file:
      - .env.server
    environment:
      WEBHOOK_DISPATCHER_ENABLED: 'true'
      WEBHOOK_BATCH_SIZE: '10'
      WEBHOOK_POLL_INTERVAL_MS: '30000'
    depends_on:
      - web
    restart: unless-stopped
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

volumes: {}
